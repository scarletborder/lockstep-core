# Lockstep Client React 测试应用使用说明

## 概述

这是一个可视化的测试应用，提供了完整的 UI 界面来测试 Lockstep WebTransport 客户端的所有功能。

## 界面布局

```
┌─────────────────────────────────────────────────────────┐
│  🎮 Lockstep Client 测试面板          [⚙️ 配置] ←右上角 │
├────────────┬────────────────┬──────────────────────────┤
│            │                │                          │
│  HTTP      │   游戏请求     │    消息日志              │
│  请求测试   │   测试面板     │    面板                  │
│            │                │                          │
│  WebTransport │             │                          │
│  连接面板   │                │                          │
│            │                │                          │
│  快速测试   │                │                          │
│  面板      │                │                          │
│            │                │                          │
└────────────┴────────────────┴──────────────────────────┘
```

## 测试流程

### 场景 1: 基础连接测试

1. **配置服务器**
   - 点击右上角 "⚙️ 配置"
   - 确认服务器 URL: `https://127.0.0.1:4433`
   - 确保所有安全选项已勾选

2. **创建房间**
   - 在 "HTTP 请求测试" 输入房间 ID: `test-room-001`
   - 点击 "创建房间"
   - 等待成功消息

3. **加入房间**
   - 在 "WebTransport 连接" 输入相同的房间 ID
   - 点击 "加入房间"
   - 观察连接状态变化: 未连接 → 连接中 → 大厅中 → 已连接
   - 在消息日志中查看加入成功的消息

4. **断开连接**
   - 点击 "断开连接"
   - 注意重连密钥会自动保存

### 场景 2: 完整游戏流程测试

1. **自动测试**
   - 确保当前状态为 "未连接"
   - 点击 "完整流程测试"
   - 系统会自动执行:
     - 创建房间
     - 加入房间
     - 发送准备消息
     - 选择地图
     - 发送加载完成
     - 断开连接
   - 在消息日志中观察整个流程

2. **手动测试** (更详细)
   ```
   步骤 1: 创建并加入房间 (如场景 1)
   
   步骤 2: 发送准备消息
   - 在 "游戏请求测试" → "房间准备"
   - 勾选 "准备状态"
   - 点击 "发送准备"
   - 查看日志中的响应
   
   步骤 3: 选择地图
   - 在 "地图选择" 区域
   - 输入章节 ID: 1
   - 输入关卡 ID: 1
   - 点击 "选择地图"
   
   步骤 4: 发送加载完成
   - 在 "加载状态" 区域
   - 勾选 "加载完成"
   - 点击 "发送加载"
   
   步骤 5: 游戏操作
   - 在 "游戏操作" 区域
   - 设置行: 0, 列: 0, 卡片: 1
   - 点击 "种植" 放置植物
   - 点击 "移除植物" 清除植物
   - 点击 "星星碎片" 使用特殊能力
   
   步骤 6: 结束游戏
   - 点击 "结束游戏"
   - 观察服务器响应
   ```

### 场景 3: 重连测试

1. **首次连接**
   - 创建并加入房间 (参考场景 1)
   - 等待连接成功
   - 注意右侧显示的玩家 ID 和房间信息

2. **断开连接**
   - 点击 "断开连接"
   - 重连密钥会显示在连接面板中

3. **重新连接**
   - 确保房间 ID 仍是之前的
   - 点击 "使用密钥重连"
   - 观察是否成功重连并保持之前的玩家 ID

4. **自动重连测试**
   - 或者直接点击 "重连流程测试"
   - 系统会自动执行上述步骤

### 场景 4: 压力测试

1. **连接到房间**
   - 确保已经成功连接到某个房间

2. **运行压力测试**
   - 点击 "消息压力测试 (需已连接)"
   - 系统会连续发送 50 条心跳消息
   - 在日志中观察消息发送情况
   - 检查是否有消息丢失或错误

3. **手动心跳测试**
   - 在 "基础消息" 区域
   - 调整帧 ID 和确认帧 ID
   - 点击 "心跳" 手动发送
   - 适合测试特定帧场景

## 测试检查清单

### HTTP 功能
- [ ] 获取房间列表
- [ ] 创建新房间
- [ ] 创建已存在的房间 (应该失败)
- [ ] 获取包含新创建房间的列表

### WebTransport 连接
- [ ] 加入存在的房间
- [ ] 加入不存在的房间 (应该失败)
- [ ] 断开连接
- [ ] 使用密钥重连
- [ ] 使用错误密钥重连 (应该失败)

### 游戏请求
- [ ] 发送心跳 (blank)
- [ ] 发送准备/取消准备 (ready)
- [ ] 选择地图 (chooseMap)
- [ ] 离开地图选择 (leaveChooseMap)
- [ ] 发送加载完成 (loaded)
- [ ] 种植植物 (plant)
- [ ] 移除植物 (removePlant)
- [ ] 使用星星碎片 (starShards)
- [ ] 结束游戏 (endGame)

### 边界条件测试
- [ ] 未连接时发送游戏消息 (应该被禁用)
- [ ] 连接期间再次点击加入 (应该被禁用)
- [ ] 快速连续发送多个消息
- [ ] 断开后立即重连

## 调试技巧

### 查看消息详情
- 消息日志面板会显示所有发送和接收的消息
- 颜色标识:
  - 🔵 蓝色 = 大厅消息
  - 🟣 紫色 = 房间消息
  - 🔴 红色 = 错误消息
  - 🟡 黄色 = 状态变化
  - ⚪ 灰色 = 信息消息

### 常见问题排查

**问题**: 无法连接到服务器
```
检查:
1. 服务器是否正在运行
2. URL 是否正确
3. 浏览器控制台是否有错误
4. 安全选项是否已启用
```

**问题**: 消息发送失败
```
检查:
1. 连接状态是否为 "已连接"
2. 消息参数是否正确
3. 服务器日志是否有错误
```

**问题**: 收不到服务器响应
```
检查:
1. 消息日志面板是否有新消息
2. 浏览器开发者工具网络面板
3. 服务器是否正常处理消息
```

## 开发者选项

### 浏览器开发者工具
按 F12 打开开发者工具，可以查看:
- Console: JavaScript 错误和日志
- Network: WebTransport 连接状态
- Application: 本地存储 (如果有)

### 修改配置
在 `App.tsx` 中可以修改默认配置:
```typescript
const [config, setConfig] = useState<ClientConfig>({
  serverUrl: 'https://127.0.0.1:4433',  // 修改默认服务器
  allowSelfSigned: true,
  allowInsecureTransport: true,
  allowAnyCert: true,
});
```

## 扩展功能

### 添加自定义测试
在 `components/` 目录下创建新组件，例如:
```typescript
// CustomTestPanel.tsx
export function CustomTestPanel({ client }: { client: LockstepClient | null }) {
  // 你的测试逻辑
  return <div>自定义测试面板</div>;
}
```

然后在 `App.tsx` 中导入使用。

### 保存测试配置
可以使用 localStorage 保存常用配置:
```typescript
localStorage.setItem('lastRoomId', roomId);
const savedRoomId = localStorage.getItem('lastRoomId') || '';
```

## 性能建议

- 压力测试时建议关闭日志面板以提高性能
- 长时间测试后可以点击 "清空" 清理日志
- 测试完成后及时断开连接释放资源

## 参考资料

- [TypeScript SDK 文档](../ts-app/README.md)
- [API 参考](../../docs/QUICK_REFERENCE.md)
- [完整开发文档](../../docs/QUICKSTART.md)
